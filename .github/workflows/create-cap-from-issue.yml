name: Create CAP folder and README from Issue

on:
  issues:
    types: [opened]

jobs:
  generate-cap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate CAP folder and README
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # ✅ Count existing CAP folders (ignore CAP-9999)
          CAP_COUNT=$(ls -d CAP-* 2>/dev/null | grep -v 'CAP-9999' | wc -l)
          CAP_NUMBER=$(printf "%04d" $((CAP_COUNT + 1)))

          FOLDER="CAP-${CAP_NUMBER}"
          FILE_PATH="${FOLDER}/README.md"
          DATE=$(date +%Y-%m-%d)

          mkdir -p "$FOLDER"

          # ✅ Title from issue title
          TITLE="$ISSUE_TITLE"
          TITLE=$(echo "$TITLE" | sed -E 's/^CAP[: ]*//')

          NORMALIZED_BODY=$(echo "$ISSUE_BODY" | tr -d '\r')

          # ✅ Multiline-safe parsing
          CATEGORY=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Category[^\n]*\n+([^\n#]+)/' | xargs)
          IMPLEMENTORS=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Implementors[^\n]*\n+([^\n#]+)/' | xargs)
          SOLUTION_TO=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Solution-To[^\n]*\n+([^\n#]+)/' | xargs)
          DISCUSSIONS=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Discussions[^\n]*\n+([^\n#]+)/' | xargs)
          ABSTRACT=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Abstract[^\n]*\n+([^\n#]+)/' | xargs)
          MOTIVATION=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Motivation[^\n]*\n+([^\n#]+)/' | xargs)
          SPECIFICATION=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Amendment Specification[^\n]*\n+([^\n#]+)/' | xargs)
          RATIONALE=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Rationale[^\n]*\n+([^\n#]+)/' | xargs)
          ACCEPTANCE=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Acceptance Criteria[^\n]*\n+([^\n#]+)/' | xargs)
          IMPLEMENTATION=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Implementation Plan[^\n]*\n+([^\n#]+)/' | xargs)
          VERSIONING=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /Versioning[^\n]*\n+([^\n#]+)/' | xargs)
          REFERENCES=$(echo "$NORMALIZED_BODY" | perl -0777 -ne 'print $1 if /References[^\n]*\n+([^\n#]+)/' | xargs)

          # ✅ Fallbacks
          [ -z "$CATEGORY" ] && CATEGORY="N/A"
          [ -z "$IMPLEMENTORS" ] && IMPLEMENTORS="N/A"
          [ -z "$SOLUTION_TO" ] && SOLUTION_TO="N/A"
          [ -z "$DISCUSSIONS" ] && DISCUSSIONS="N/A"
          [ -z "$ABSTRACT" ] && ABSTRACT="N/A"
          [ -z "$MOTIVATION" ] && MOTIVATION="N/A"
          [ -z "$SPECIFICATION" ] && SPECIFICATION="N/A"
          [ -z "$RATIONALE" ] && RATIONALE="N/A"
          [ -z "$ACCEPTANCE" ] && ACCEPTANCE="N/A"
          [ -z "$IMPLEMENTATION" ] && IMPLEMENTATION="N/A"
          [ -z "$VERSIONING" ] && VERSIONING="N/A"
          [ -z "$REFERENCES" ] && REFERENCES="N/A"

          # ✅ Write README.md (just raw values)
          {
            echo "---"
            echo "CAP: ${CAP_NUMBER}"
            echo "Title: \"${TITLE}\""
            echo "Category: \"${CATEGORY}\""
            echo "Status: Draft"
            echo "Authors:"
            echo "  - TBD"
            echo "Implementors:"
            echo "  - \"${IMPLEMENTORS}\""
            echo "Solution-To:"
            echo "  - \"${SOLUTION_TO}\""
            echo "Discussions:"
            echo "  - \"${DISCUSSIONS}\""
            echo "Created: ${DATE}"
            echo "License: CC-BY-4.0"
            echo "---"
            echo ""
            echo "## Abstract"
            echo ""
            echo "${ABSTRACT}"
            echo ""
            echo "## Motivation: Why is this CAP necessary?"
            echo ""
            echo "${MOTIVATION}"
            echo ""
            echo "## Amendment Specification"
            echo ""
            echo "${SPECIFICATION}"
            echo ""
            echo "## Rationale: How does this CAP achieve its goals?"
            echo ""
            echo "${RATIONALE}"
            echo ""
            echo "## Path to Ratification"
            echo ""
            echo "### Acceptance Criteria"
            echo ""
            echo "${ACCEPTANCE}"
            echo ""
            echo "### Implementation Plan"
            echo ""
            echo "${IMPLEMENTATION}"
            echo ""
            echo "## Versioning (Optional)"
            echo ""
            echo "${VERSIONING}"
            echo ""
            echo "## References (Optional)"
            echo ""
            echo "${REFERENCES}"
            echo ""
            echo "## Copyright"
            echo ""
            echo "This CAP is licensed under [CC-BY-4.0](https://creativecommons.org/licenses/by/4.0/legalcode)."
          } > "$FILE_PATH"

      - name: Commit and push CAP folder
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Add CAP-${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          file_pattern: "CAP-*/*"
